{% extends "base.html" %}

{% block title %}Dashboard{% endblock %}

{% block content %}
<div class="row">
    <div class="col-md-6">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h4 class="mb-0">UPS Status</h4>
                <span id="connection-status" class="badge bg-secondary">Checking...</span>
            </div>
            <div class="card-body">
                <div id="connection-error" class="alert alert-danger d-none">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    <span id="error-message"></span>
                </div>
                <div id="status-display">
                    <div class="mb-3">
                        <h5>Power Status</h5>
                        <p class="mb-2">
                            <i id="power-icon" class="fas fa-plug me-2"></i>
                            <span id="power-status">Loading...</span>
                        </p>
                    </div>
                    <div class="mb-3">
                        <h5>Battery</h5>
                        <div class="progress mb-2">
                            <div id="battery-progress" class="progress-bar" role="progressbar" style="width: 0%"></div>
                        </div>
                        <p id="battery-text" class="text-muted">Loading...</p>
                    </div>
                    <div class="mb-3">
                        <h5>Load</h5>
                        <div class="progress mb-2">
                            <div id="load-progress" class="progress-bar bg-info" role="progressbar" style="width: 0%"></div>
                        </div>
                        <p id="load-text" class="text-muted">Loading...</p>
                    </div>
                    <div>
                        <h5>Runtime Remaining</h5>
                        <p id="runtime-text" class="mb-0">Loading...</p>
                    </div>
                </div>
                <div class="mt-3">
                    <small class="text-muted">Last Update: <span id="last-update">Never</span></small>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h4 class="mb-0">Notification Status</h4>
            </div>
            <div class="card-body">
                <ul class="list-group">
                    <li class="list-group-item d-flex justify-content-between align-items-center">
                        Webhook
                        <span id="webhook-status" class="badge bg-secondary">Unknown</span>
                    </li>
                    <li class="list-group-item d-flex justify-content-between align-items-center">
                        Email
                        <span id="email-status" class="badge bg-secondary">Unknown</span>
                    </li>
                    <li class="list-group-item d-flex justify-content-between align-items-center">
                        SMS
                        <span id="sms-status" class="badge bg-secondary">Unknown</span>
                    </li>
                </ul>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
function updateStatus() {
    fetch('/api/status')
        .then(response => response.json())
        .then(data => {
            // Update connection status
            const connectionStatus = document.getElementById('connection-status');
            const connectionError = document.getElementById('connection-error');
            const errorMessage = document.getElementById('error-message');
            const statusDisplay = document.getElementById('status-display');
            
            if (data.ups_status && data.ups_status.connected) {
                connectionStatus.textContent = 'Connected';
                connectionStatus.className = 'badge bg-success';
                connectionError.classList.add('d-none');
                statusDisplay.classList.remove('d-none');
            } else {
                connectionStatus.textContent = 'Disconnected';
                connectionStatus.className = 'badge bg-danger';
                if (data.ups_status && data.ups_status.error) {
                    errorMessage.textContent = data.ups_status.error;
                    connectionError.classList.remove('d-none');
                }
                statusDisplay.classList.add('d-none');
            }

            // Update last successful check
            const lastUpdate = document.getElementById('last-update');
            if (data.ups_status && data.ups_status.last_successful_check) {
                const lastCheck = new Date(data.ups_status.last_successful_check);
                lastUpdate.textContent = lastCheck.toLocaleString();
            }

            if (data.status && Object.keys(data.status).length > 0) {
                // Update power status
                const powerIcon = document.getElementById('power-icon');
                const powerStatus = document.getElementById('power-status');
                if (data.status.on_battery) {
                    powerIcon.className = 'fas fa-battery-half me-2 text-warning';
                    powerStatus.textContent = 'Running on Battery';
                    powerStatus.className = 'text-warning';
                } else {
                    powerIcon.className = 'fas fa-plug me-2 text-success';
                    powerStatus.textContent = 'Connected to AC Power';
                    powerStatus.className = 'text-success';
                }

                // Update battery status
                const batteryProgress = document.getElementById('battery-progress');
                const batteryText = document.getElementById('battery-text');
                batteryProgress.style.width = `${data.status.battery_level}%`;
                batteryProgress.textContent = `${data.status.battery_level}%`;
                batteryText.textContent = `Battery Level: ${data.status.battery_level}%`;

                // Update load status
                const loadProgress = document.getElementById('load-progress');
                const loadText = document.getElementById('load-text');
                loadProgress.style.width = `${data.status.load_percentage}%`;
                loadProgress.textContent = `${data.status.load_percentage}%`;
                loadText.textContent = `Load: ${data.status.load_percentage}%`;

                // Update runtime
                const runtimeText = document.getElementById('runtime-text');
                const minutes = Math.floor(data.status.runtime_remaining / 60);
                const seconds = data.status.runtime_remaining % 60;
                runtimeText.textContent = `${minutes}m ${seconds}s`;
            }

            // Update notification status
            ['webhook', 'email', 'sms'].forEach(type => {
                const status = document.getElementById(`${type}-status`);
                if (data.notifications && data.notifications[type]) {
                    status.textContent = 'Enabled';
                    status.className = 'badge bg-success';
                } else {
                    status.textContent = 'Disabled';
                    status.className = 'badge bg-secondary';
                }
            });
        })
        .catch(error => {
            console.error('Error fetching status:', error);
            const connectionStatus = document.getElementById('connection-status');
            connectionStatus.textContent = 'Error';
            connectionStatus.className = 'badge bg-danger';
        });
}

// Update status every 5 seconds
setInterval(updateStatus, 5000);
updateStatus();  // Initial update
</script>
{% endblock %} 