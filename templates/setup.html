{% extends "base.html" %}

{% block title %}Power Snitch - Initial Setup{% endblock %}

{% block content %}
<div class="container py-4">
    <h1 class="text-center mb-4">Power Snitch Setup</h1>
    
    {% if form.errors %}
    <div class="alert alert-danger">
        <h4>Please correct the following errors:</h4>
        <ul>
            {% for field, errors in form.errors.items() %}
                {% for error in errors %}
                    <li>{{ field }}: {{ error }}</li>
                {% endfor %}
            {% endfor %}
        </ul>
    </div>
    {% endif %}
    
    <form method="POST" action="{{ url_for('setup') }}">
        {{ form.csrf_token }}
        
        <!-- Web Interface Settings -->
        <div class="card mb-4">
            <div class="card-body">
                <h3 class="card-title">Web Interface Settings</h3>
                <div class="form-group">
                    {{ form.web_interface_port.label }}
                    {{ form.web_interface_port(class="form-control") }}
                    {% if form.web_interface_port.errors %}
                        {% for error in form.web_interface_port.errors %}
                            <div class="text-danger small mt-1">{{ error }}</div>
                        {% endfor %}
                    {% endif %}
                </div>
                <div class="form-group">
                    {{ form.web_interface_password.label }}
                    {{ form.web_interface_password(class="form-control") }}
                    {% if config.web_interface.password_hash %}
                        <div class="text-muted small mt-1">Password is set</div>
                    {% endif %}
                    {% if form.web_interface_password.description %}
                        <div class="form-text">{{ form.web_interface_password.description }}</div>
                    {% endif %}
                    {% if form.web_interface_password.errors %}
                        {% for error in form.web_interface_password.errors %}
                            <div class="text-danger small mt-1">{{ error }}</div>
                        {% endfor %}
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- UPS and NUT Configuration -->
        <div class="card mb-4">
            <div class="card-body">
                <h3 class="card-title">UPS Configuration</h3>
                
                <!-- Basic UPS Information -->
                <div class="form-group mb-4">
                    <h4 class="h5">Basic Information</h4>
                    <div class="form-group">
                        {{ form.ups_name.label }}
                        {{ form.ups_name(class="form-control") }}
                        {% if form.ups_name.errors %}
                            {% for error in form.ups_name.errors %}
                                <div class="text-danger small mt-1">{{ error }}</div>
                            {% endfor %}
                        {% endif %}
                    </div>
                    <div class="form-group">
                        {{ form.ups_description.label }}
                        {{ form.ups_description(class="form-control") }}
                        {% if form.ups_description.errors %}
                            {% for error in form.ups_description.errors %}
                                <div class="text-danger small mt-1">{{ error }}</div>
                            {% endfor %}
                        {% endif %}
                    </div>
                    <div class="form-group">
                        {{ form.ups_poll_interval.label }}
                        {{ form.ups_poll_interval(class="form-control") }}
                        {% if form.ups_poll_interval.errors %}
                            {% for error in form.ups_poll_interval.errors %}
                                <div class="text-danger small mt-1">{{ error }}</div>
                            {% endfor %}
                        {% endif %}
                    </div>
                </div>

                <!-- NUT Connection Settings -->
                <div class="form-group">
                    <h4 class="h5">NUT Connection Settings</h4>
                    <div class="form-group">
                        {{ form.nut_driver.label }}
                        {{ form.nut_driver(class="form-control") }}
                        {% if form.nut_driver.description %}
                            <div class="form-text">{{ form.nut_driver.description }}</div>
                        {% endif %}
                        {% if form.nut_driver.errors %}
                            {% for error in form.nut_driver.errors %}
                                <div class="text-danger small mt-1">{{ error }}</div>
                            {% endfor %}
                        {% endif %}
                    </div>
                    <div class="form-group">
                        {{ form.nut_port.label }}
                        {{ form.nut_port(class="form-control") }}
                        {% if form.nut_port.description %}
                            <div class="form-text">{{ form.nut_port.description }}</div>
                        {% endif %}
                        {% if form.nut_port.errors %}
                            {% for error in form.nut_port.errors %}
                                <div class="text-danger small mt-1">{{ error }}</div>
                            {% endfor %}
                        {% endif %}
                    </div>
                    <div class="form-group">
                        {{ form.nut_username.label }}
                        {{ form.nut_username(class="form-control") }}
                        {% if form.nut_username.description %}
                            <div class="form-text">{{ form.nut_username.description }}</div>
                        {% endif %}
                        {% if form.nut_username.errors %}
                            {% for error in form.nut_username.errors %}
                                <div class="text-danger small mt-1">{{ error }}</div>
                            {% endfor %}
                        {% endif %}
                    </div>
                    <div class="form-group">
                        {{ form.nut_password.label }}
                        {{ form.nut_password(class="form-control") }}
                        {% if form.nut_password.description %}
                            <div class="form-text">{{ form.nut_password.description }}</div>
                        {% endif %}
                        {% if form.nut_password.errors %}
                            {% for error in form.nut_password.errors %}
                                <div class="text-danger small mt-1">{{ error }}</div>
                            {% endfor %}
                        {% endif %}
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                {{ form.nut_retry_count.label }}
                                {{ form.nut_retry_count(class="form-control") }}
                                {% if form.nut_retry_count.description %}
                                    <div class="form-text">{{ form.nut_retry_count.description }}</div>
                                {% endif %}
                                {% if form.nut_retry_count.errors %}
                                    {% for error in form.nut_retry_count.errors %}
                                        <div class="text-danger small mt-1">{{ error }}</div>
                                    {% endfor %}
                                {% endif %}
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                {{ form.nut_retry_delay.label }}
                                {{ form.nut_retry_delay(class="form-control") }}
                                {% if form.nut_retry_delay.description %}
                                    <div class="form-text">{{ form.nut_retry_delay.description }}</div>
                                {% endif %}
                                {% if form.nut_retry_delay.errors %}
                                    {% for error in form.nut_retry_delay.errors %}
                                        <div class="text-danger small mt-1">{{ error }}</div>
                                    {% endfor %}
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Notification Settings -->
        <div class="card mb-4">
            <div class="card-body">
                <h3 class="card-title">Notification Settings</h3>
                
                <!-- Webhook -->
                <div class="notification-section mb-4" data-service="webhook" data-expanded="{{ form.webhook_enabled.data|lower }}">
                    <h4 class="h5 d-flex justify-content-between align-items-center">
                        <span>Webhook</span>
                        <button type="button" class="btn btn-link service-toggle">
                            <i class="fas fa-chevron-down"></i>
                        </button>
                    </h4>
                    <div class="form-group">
                        <div class="form-check">
                            {{ form.webhook_enabled(class="form-check-input") }}
                            <label class="form-check-label">Enable Webhook</label>
                        </div>
                    </div>
                    <div class="fields mt-3">
                        <div class="form-group">
                            {{ form.webhook_url.label }}
                            {{ form.webhook_url(class="form-control") }}
                            {% if form.webhook_url.description %}
                                <div class="form-text">{{ form.webhook_url.description }}</div>
                            {% endif %}
                            {% if form.webhook_url.errors %}
                                {% for error in form.webhook_url.errors %}
                                    <div class="text-danger small mt-1">{{ error }}</div>
                                {% endfor %}
                            {% endif %}
                        </div>
                        <div class="form-group">
                            {{ form.webhook_method.label }}
                            {{ form.webhook_method(class="form-control") }}
                            {% if form.webhook_method.description %}
                                <div class="form-text">{{ form.webhook_method.description }}</div>
                            {% endif %}
                            {% if form.webhook_method.errors %}
                                {% for error in form.webhook_method.errors %}
                                    <div class="text-danger small mt-1">{{ error }}</div>
                                {% endfor %}
                            {% endif %}
                        </div>
                        <div class="form-group">
                            {{ form.webhook_timeout.label }}
                            {{ form.webhook_timeout(class="form-control") }}
                            {% if form.webhook_timeout.description %}
                                <div class="form-text">{{ form.webhook_timeout.description }}</div>
                            {% endif %}
                            {% if form.webhook_timeout.errors %}
                                {% for error in form.webhook_timeout.errors %}
                                    <div class="text-danger small mt-1">{{ error }}</div>
                                {% endfor %}
                            {% endif %}
                        </div>
                        <div class="form-group">
                            {{ form.webhook_headers.label }}
                            {{ form.webhook_headers(class="form-control", rows=4) }}
                            {% if form.webhook_headers.description %}
                                <div class="form-text">{{ form.webhook_headers.description }}</div>
                            {% endif %}
                            {% if form.webhook_headers.errors %}
                                {% for error in form.webhook_headers.errors %}
                                    <div class="text-danger small mt-1">{{ error }}</div>
                                {% endfor %}
                            {% endif %}
                        </div>
                    </div>
                </div>

                <!-- Email -->
                <div class="notification-section mb-4" data-service="email" data-expanded="{{ form.email_enabled.data|lower }}">
                    <h4 class="h5 d-flex justify-content-between align-items-center">
                        <span>Email</span>
                        <button type="button" class="btn btn-link service-toggle">
                            <i class="fas fa-chevron-down"></i>
                        </button>
                    </h4>
                    <div class="form-group">
                        <div class="form-check">
                            {{ form.email_enabled(class="form-check-input") }}
                            <label class="form-check-label">Enable Email</label>
                        </div>
                    </div>
                    <div class="fields mt-3">
                        <div class="form-group">
                            {{ form.email_smtp_host.label }}
                            {{ form.email_smtp_host(class="form-control") }}
                            {% if form.email_smtp_host.description %}
                                <div class="form-text">{{ form.email_smtp_host.description }}</div>
                            {% endif %}
                            {% if form.email_smtp_host.errors %}
                                {% for error in form.email_smtp_host.errors %}
                                    <div class="text-danger small mt-1">{{ error }}</div>
                                {% endfor %}
                            {% endif %}
                        </div>
                        <div class="form-group">
                            {{ form.email_smtp_port.label }}
                            {{ form.email_smtp_port(class="form-control") }}
                            {% if form.email_smtp_port.description %}
                                <div class="form-text">{{ form.email_smtp_port.description }}</div>
                            {% endif %}
                            {% if form.email_smtp_port.errors %}
                                {% for error in form.email_smtp_port.errors %}
                                    <div class="text-danger small mt-1">{{ error }}</div>
                                {% endfor %}
                            {% endif %}
                        </div>
                        <div class="form-group">
                            {{ form.email_smtp_username.label }}
                            {{ form.email_smtp_username(class="form-control") }}
                            {% if form.email_smtp_username.description %}
                                <div class="form-text">{{ form.email_smtp_username.description }}</div>
                            {% endif %}
                            {% if form.email_smtp_username.errors %}
                                {% for error in form.email_smtp_username.errors %}
                                    <div class="text-danger small mt-1">{{ error }}</div>
                                {% endfor %}
                            {% endif %}
                        </div>
                        <div class="form-group">
                            {{ form.email_smtp_password.label }}
                            {{ form.email_smtp_password(class="form-control") }}
                            {% if config.notifications.email and config.notifications.email.smtp_password %}
                                <div class="text-muted small mt-1">Password is set</div>
                            {% endif %}
                            {% if form.email_smtp_password.description %}
                                <div class="form-text">{{ form.email_smtp_password.description }}</div>
                            {% endif %}
                            {% if form.email_smtp_password.errors %}
                                {% for error in form.email_smtp_password.errors %}
                                    <div class="text-danger small mt-1">{{ error }}</div>
                                {% endfor %}
                            {% endif %}
                        </div>
                        <div class="form-group">
                            <div class="form-check">
                                {{ form.email_smtp_use_tls(class="form-check-input") }}
                                <label class="form-check-label">{{ form.email_smtp_use_tls.label }}</label>
                                {% if form.email_smtp_use_tls.description %}
                                    <div class="form-text">{{ form.email_smtp_use_tls.description }}</div>
                                {% endif %}
                            </div>
                        </div>
                        <div class="form-group">
                            {{ form.email_from_email.label }}
                            {{ form.email_from_email(class="form-control") }}
                            {% if form.email_from_email.description %}
                                <div class="form-text">{{ form.email_from_email.description }}</div>
                            {% endif %}
                            {% if form.email_from_email.errors %}
                                {% for error in form.email_from_email.errors %}
                                    <div class="text-danger small mt-1">{{ error }}</div>
                                {% endfor %}
                            {% endif %}
                        </div>
                        <div class="form-group">
                            {{ form.email_recipients.label }}
                            {{ form.email_recipients(class="form-control") }}
                            {% if form.email_recipients.description %}
                                <div class="form-text">{{ form.email_recipients.description }}</div>
                            {% endif %}
                            {% if form.email_recipients.errors %}
                                {% for error in form.email_recipients.errors %}
                                    <div class="text-danger small mt-1">{{ error }}</div>
                                {% endfor %}
                            {% endif %}
                        </div>
                    </div>
                </div>

                <!-- SMS -->
                <div class="notification-section mb-4" data-service="sms" data-expanded="{{ form.sms_enabled.data|lower }}">
                    <h4 class="h5 d-flex justify-content-between align-items-center">
                        <span>SMS</span>
                        <button type="button" class="btn btn-link service-toggle">
                            <i class="fas fa-chevron-down"></i>
                        </button>
                    </h4>
                    <div class="form-group">
                        <div class="form-check">
                            {{ form.sms_enabled(class="form-check-input") }}
                            <label class="form-check-label">Enable SMS</label>
                        </div>
                    </div>
                    <div class="fields mt-3">
                        <div class="form-group">
                            {{ form.sms_account_sid.label }}
                            {{ form.sms_account_sid(class="form-control") }}
                            {% if form.sms_account_sid.description %}
                                <div class="form-text">{{ form.sms_account_sid.description }}</div>
                            {% endif %}
                            {% if form.sms_account_sid.errors %}
                                {% for error in form.sms_account_sid.errors %}
                                    <div class="text-danger small mt-1">{{ error }}</div>
                                {% endfor %}
                            {% endif %}
                        </div>
                        <div class="form-group">
                            {{ form.sms_auth_token.label }}
                            {{ form.sms_auth_token(class="form-control") }}
                            {% if config.notifications.sms and config.notifications.sms.auth_token %}
                                <div class="text-muted small mt-1">Token is set</div>
                            {% endif %}
                            {% if form.sms_auth_token.description %}
                                <div class="form-text">{{ form.sms_auth_token.description }}</div>
                            {% endif %}
                            {% if form.sms_auth_token.errors %}
                                {% for error in form.sms_auth_token.errors %}
                                    <div class="text-danger small mt-1">{{ error }}</div>
                                {% endfor %}
                            {% endif %}
                        </div>
                        <div class="form-group">
                            {{ form.sms_from_number.label }}
                            {{ form.sms_from_number(class="form-control") }}
                            {% if form.sms_from_number.description %}
                                <div class="form-text">{{ form.sms_from_number.description }}</div>
                            {% endif %}
                            {% if form.sms_from_number.errors %}
                                {% for error in form.sms_from_number.errors %}
                                    <div class="text-danger small mt-1">{{ error }}</div>
                                {% endfor %}
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <button type="submit" class="btn btn-primary w-100">Complete Setup</button>
    </form>
</div>
{% endblock %}

{% block extra_js %}
<script src="{{ url_for('static', filename='js/setup.js') }}"></script>
{% endblock %} 